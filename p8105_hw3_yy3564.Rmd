---
title: "p8105_hw3_yy3564"
author: "Yonghao YU"
date: "2024-10-10"
output: github_document
---

# Problem 2

```{r, message=FALSE}
library(tidyverse)
```
```{r}
demographic = 
  read_csv("data/nhanes_covar.csv", skip = 4, na = c("NA","",".")) |>
  janitor::clean_names() |>
  drop_na(sex:education) |>
  filter(age>21) |>
  mutate(education = factor(education, levels = c("1", "2", "3"), labels = c("Less than high school", "High school equivalent", "More than high school"), ordered = TRUE)) |>
  mutate(sex = factor(sex, levels=c("1", "2"), labels = c("male", "female"), ordered = TRUE))
demographic
```


```{r}
accelerometer = 
  read_csv("data/nhanes_accel.csv", na = c("NA","",".")) |>
  janitor::clean_names() |>
  drop_na()|>
  pivot_longer(min1:min1440, names_to = "minute", values_to = "mims_value")
accelerometer
```
```{r}
final_df = full_join(demographic,accelerometer) |>
  drop_na() |>
  mutate(minute = str_remove(minute, "[^0-9]+"))
final_df
```
```{r}
demographic |>
  group_by(sex,education) |>
  summarise(num_obs=n())
```
```{r}
ggplot(demographic,aes(x = education, y = age)) +
  geom_violin(aes(fill = sex), alpha = 0.5) +
  labs(title = "Age Distributions by Sex and Education Level",
       x = "Education Level",
       y = "Age")
```
```{r}
activity_df = final_df |>
  group_by(sex,minute,education,age) |>
  summarise(total_value = sum(mims_value, na.rm = TRUE))
activity_df
```

```{r}
ggplot(activity_df, aes(x = age, y = total_value, color = sex)) +
  geom_point(alpha = 0.5) +  # Add scatter points with transparency
  geom_smooth(method = "loess", se = FALSE) +  # Add a smooth trend line (using LOESS)
  facet_grid(~ education) +  # Separate panels by education level
  labs(title = "Total Activity vs Age by Gender and Education Level",
       x = "Age",
       y = "Total Activity",
       color = "Sex") +  # Label axes and color legend
  theme_minimal()  # Use a minimal theme for a clean look
```


```{r}
activity_df2 = final_df |>
  mutate(minute = as.numeric(minute)) |>
  mutate(hour = floor((minute - 1) / 60) + 1) |>
  group_by(education,sex, hour)|>
  summarise(total_value = sum(mims_value, na.rm = TRUE))
activity_df2
```
```{r}
ggplot(activity_df2, aes(x = hour, y = total_value, color = sex)) +
  geom_point(alpha = .4) +  # Add lines for activity over time
  geom_smooth(method = "loess", se = FALSE) +  # Add smooth trends with loess
  facet_grid(~ education) +  # Create separate panels for each education level
  labs(title = "24-Hour Activity Time Course by Education Level",
       x = "Time of Day (in hour)",
       y = "Mean Activity",
       color = "sex") +  # Label axes and legend
  theme_minimal() +  # Use a minimal theme for a clean plot
  theme(panel.spacing = unit(2, "lines"))
```

```{r}
Jan20 = 
  read_csv("data/Jan 2020 Citi.csv", na = c("NA","",".")) |>
  janitor::clean_names() |>
  mutate(year = 2020, month = "January")
Jan20
```

```{r}
July20 = 
  read_csv("data/July 2020 Citi.csv", na = c("NA","",".")) |>
  janitor::clean_names() |>
  mutate(year = 2020, month = "July")
July20
```

```{r}
Jan24 = 
  read_csv("data/Jan 2024 Citi.csv", na = c("NA","",".")) |>
  janitor::clean_names() |>
  mutate(year = 2024, month = "January")
Jan24
```

```{r}
July24 = 
  read_csv("data/July 2024 Citi.csv", na = c("NA","",".")) |>
  janitor::clean_names() |>
  mutate(year = 2024, month = "July")
July24
```
```{r}
# Combine all data then clean any missing data
all_data =
  bind_rows(Jan20, July20, Jan24, July24) |>
  drop_na()
all_data
```

```{r}
# Step 2: Produce a reader-friendly table showing total number of rides by year and month
total_rides = 
  all_data |>
  group_by(year, month, member_casual) |>
  summarise(total_rides = n()) |>
  arrange(year, month, member_casual)
total_rides
```
```{r}
july_2024_data = all_data |>
  filter(year == 2024, month == "July")

popular_stations = july_2024_data |>
  group_by(start_station_name) |>
  summarise(ride_count = n()) |>
  arrange(desc(ride_count)) |>
  head(5)

popular_stations
```

```{r}
# Step 4: Investigate the effects of day of week, month, and year on median ride duration
median_duration <- all_data |>
  group_by(weekdays, month, year) |>
  summarise(median_duration = median(duration)) |>
  mutate(weekdays = case_when(
    weekdays == "Monday" ~ 1,
    weekdays == "Tuesday" ~ 2,
    weekdays == "Wednesday" ~ 3,
    weekdays == "Thursday" ~ 4,
    weekdays == "Friday" ~ 5,
    weekdays == "Saturday" ~ 6,
    weekdays == "Sunday" ~ 7
  ))

# Plot the median ride duration
ggplot(median_duration, aes(x = weekdays, y = median_duration, color = month, group = interaction(year, month))) +
  geom_line() +
  geom_point() +
  facet_wrap(~ year) +
  labs(title = "Median Ride Duration by Day of Week, Month, and Year", 
       x = "Day of Week", 
       y = "Median Ride Duration (Minutes)") +
  theme_minimal() +
  theme(panel.spacing = unit(3, "lines"))
```

```{r}
# Step 5: Investigate the impact of month, membership status, and bike type on ride duration in 2024
data_2024 = all_data |>
  filter(year == 2024)

# Plot distribution of ride duration based on bike type, month, and membership status
ggplot(data_2024, aes(x = month, y = duration, fill = rideable_type)) +
  geom_boxplot() +
  facet_wrap(~ member_casual) +
  labs(title = "Ride Duration Distribution in 2024 by Month and Bike Type", 
       x = "Month", 
       y = "Ride Duration (Minutes)") +
  theme_minimal()
```


